---
title: "ElectionAnalysis"
author: "sonestak"
date: "December 23, 2016"
output:
  html_document:
    theme: united
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Read In Files and Clean
```{r read vote file in, cache=TRUE}
votes = read.csv("C:/Users/onest/desktop/2012-and-2016-presidential-elections/votes.csv", header=T)

religion = read.csv("C:/Users/onest/desktop/2012-and-2016-presidential-elections/religion.csv", header=T)
religions = religion[,c(1,43,44,45,46,47,48,49,50,51,52,53,54,55)]
colnames(religions) = c("FIPS", "Total_Pop", "Evangelical", "Protestant", "Historically_Black", "Catholic", "Jewish", "Mormon", "Islamic", "Hindu", "Buddhist", "Orthodox", "Jehovas_Witnesses", "Other_Religion")

votes = merge(x=votes,y=religions,by="FIPS", all.x=T)
```

#Exploratory Analaysis - Maps

##Basics
```{r basic data understanding,cache=TRUE}
colnames(votes)[c(29:31,33,36:39,41:43,47:54,56,58:75)] = c("Population 2012",
                                                         "Persons Under 5", 
                                                         "Persons Under 18",
                                                         "% Female 2014",
                                                         "Indian and Alaskan Native",
                                                         "Asian",
                                                         "Native Hawaiian",
                                                         "2+ Races",
                                                         "White",
                                                         "Living in Same House 1+ Years",
                                                         "Foreign Born",
                                                         "Veterans",
                                                         "Travel Time to Work",
                                                         "Housing Units 2014",
                                                         "Homeownership Rate",
                                                         "Housing Units in Multi-Unit Structures",
                                                         "Median Value of Owner-Occupied Housing Units",
                                                         "Households",
                                                         "Persons/Household",
                                                         "Median Household Income",
                                                         "Private Nonfarm Establishments 2013",
                                                         "Private Nonfarm Employment",
                                                         "% Change - Private Nonfarm Employment",
                                                         "Nonemployer Establishments - 2013",
                                                         "Total Number of Firms",
                                                         "Black-Owned Firms",
                                                         "Indidan and Alaskan -Owned Firms",
                                                         "Asian-Owned Firms",
                                                         "Hawaiian-Owned Firms",
                                                         "Hispanic-Owned Firms",
                                                         "Women", 
                                                         "Manufacturers Shipments - 2007",
                                                         "Merchant Wholesaler Sales - 2007",
                                                         "Retail Sales - 2007",
                                                         "Retail Sales / Capita - 2007",
                                                         "Accommodation and Food Service Sales - 2007",
                                                         "Building Permits",
                                                         "Land Area (in sq miles)")
colnames(votes)
```

##Vote Share Plots
```{r voter share plots, cache=TRUE}
library("choroplethr")
library("choroplethrMaps")
library("ggplot2")

#Explore total votes per county
total_votes = votes[,c(1,7)]
colnames(total_votes) = c('region','value')

vote_count = county_choropleth(total_votes,
                               legend = "Votes",
                               num_colors = 9,
                               title = "Vote Count by County",
                               state_zoom=c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
vote_count

#Break down county vote into regions of the US for easier viewing

##New England Region
vote_count_NE = county_choropleth(total_votes,
                               legend = "Votes",
                               num_colors = 9,
                               title = "Vote Count by County - New England",
                               state_zoom = c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island"))
vote_count_NE

##Mid-Atlantic Region
vote_count_MA = county_choropleth(total_votes,
                               legend = "Votes",
                               num_colors = 9,
                               title = "Vote Count by County - Mid-Atlantic",
                               state_zoom = c("new york", "pennsylvania", "new jersey", "maryland","delaware"))
vote_count_MA

##South East Region
vote_count_SE = county_choropleth(total_votes,
                               legend = "Votes",
                               num_colors = 9,
                               title = "Vote Count by County - South East",
                               state_zoom = c("west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana"))
vote_count_SE

##Mid West Region
vote_count_MW = county_choropleth(total_votes,
                               legend = "Votes",
                               num_colors = 9,
                               title = "Vote Count by County - Mid-West",
                               state_zoom = c("ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas"))
vote_count_MW

##South West Region
vote_count_SW = county_choropleth(total_votes,
                               legend = "Votes",
                               num_colors = 9,
                               title = "Vote Count by County - South West",
                               state_zoom = c("texas","oklahoma","new mexico","arizona"))
vote_count_SW


##West Region
vote_count_W = county_choropleth(total_votes,
                               legend = "Votes",
                               num_colors = 9,
                               title = "Vote Count by County - West",
                               state_zoom = c("colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
vote_count_W


#Explore Vote Count by Swing States
vote_count_swing = county_choropleth(total_votes,
                                     legend = "Votes",
                                     num_colors = 9,
                                     title = "Vote Count by County - Swing States",
                                     state_zoom = c("new hampshire","pennsylvania","ohio","michigan","north carolina","florida","arizona","iowa","nevada","wisconsin","virginia","colorado","minnesota","maine"))
vote_count_swing
```

#Obama to Clinton (2012 to 2016 Change)
```{r change in total number of democratic votes from Obama to Clinton, cache=TRUE}
votes$change_dem_votes = votes$votes_dem_2016 - votes$votes_dem_2012

dem_votes = votes[,c(1,96)]
dem_votes[,3] = NA
colnames(dem_votes) = c('region','votes','value')

for(i in seq(1:dim(dem_votes)[1])){
  if(dem_votes[i,2] > 0 && dem_votes[i,2] < 1000){
    dem_votes[i,3] = "Gain - Small (<1000)"
  } else if(dem_votes[i,2] > 1000 && dem_votes[i,2] < 10000){
    dem_votes[i,3] = "Gain - Considerable (1000-10000)"
  } else if(dem_votes[i,2] >= 10000){
    dem_votes[i,3] = "Gain - Large (>10000)"
  } else if(dem_votes[i,2] < 0 && dem_votes[i,2] > -1000) {
    dem_votes[i,3] = "Loss - Small (<1000)"
  } else if(dem_votes[i,2] < -1000 && dem_votes[i,2] > -10000){
    dem_votes[i,3] = "Loss - Considerable (1000-10000)"
  } else if(dem_votes[i,2] < -10000){
    dem_votes[i,3] = "Loss - Large (>10000)"
  } else{
  dem_votes[i,3] = "Equal"
  }
}

c = CountyChoropleth$new(dem_votes)
c$title = "Change from Obama to Clinton where Blue Represents better Clinton Performance"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(7)
c$ggplot_scale = scale_fill_manual(values = c("white", "blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
dem_change_US = c$render() + 
              theme(legend.position = "right")
dem_change_US

#Break down county vote into regions of the US for easier viewing

##New England Region
c = CountyChoropleth$new(dem_votes)
c$title = "Change from Obama to Clinton (Blue = Better Clinton) - New England"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island"))
dem_change_NE = c$render() + 
              theme(legend.position = "right")
dem_change_NE

##Mid-Atlantic Region
c = CountyChoropleth$new(dem_votes)
c$title = "Change from Obama to Clinton (Blue = Better Clinton) - Mid-Atlantic"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("new york", "pennsylvania", "new jersey", "maryland","delaware"))
dem_change_MA = c$render() + 
              theme(legend.position = "right")
dem_change_MA

##South East Region
c = CountyChoropleth$new(dem_votes)
c$title = "Change from Obama to Clinton (Blue = Better Clinton) - South East"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(7)
c$ggplot_scale = scale_fill_manual(values = c("white","blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana"))
dem_change_SE = c$render() + 
              theme(legend.position = "right")
dem_change_SE

##Mid West Region
c = CountyChoropleth$new(dem_votes)
c$title = "Change from Obama to Clinton (Blue = Better Clinton) - Mid West"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas"))
dem_change_MW = c$render() + 
              theme(legend.position = "right")
dem_change_MW

##South West Region
c = CountyChoropleth$new(dem_votes)
c$title = "Change from Obama to Clinton (Blue = Better Clinton) - South West"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(7)
c$ggplot_scale = scale_fill_manual(values = c("white","blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("texas","oklahoma","new mexico","arizona"))
dem_change_SW = c$render() + 
              theme(legend.position = "right")
dem_change_SW

##West Region
c = CountyChoropleth$new(dem_votes)
c$title = "Change from Obama to Clinton (Blue = Better Clinton) - West"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(7)
c$ggplot_scale = scale_fill_manual(values = c("white","blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington","alaska","hawaii"))
dem_change_W = c$render() + 
              theme(legend.position = "right")
dem_change_W

#Explore Vote Count by Swing States
c = CountyChoropleth$new(dem_votes)
c$title = "Change from Obama to Clinton (Blue = Better Clinton) - Swing States"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("new hampshire","pennsylvania","ohio","michigan","north carolina","florida","arizona","iowa","nevada","wisconsin","virginia","colorado","minnesota","maine"))
dem_change_swing = c$render() + 
              theme(legend.position = "right")
dem_change_swing
```

#Romney to Trump (2012 to 2016 Change)
```{r change in total number of republican votes from Romney to Trump, cache=TRUE}
votes$change_rep_votes = votes$votes_gop_2016 - votes$votes_gop_2012

rep_votes = votes[,c(1,97)]
rep_votes[,3] = NA
colnames(rep_votes) = c('region','votes','value')

for(i in seq(1:dim(rep_votes)[1])){
  if(rep_votes[i,2] > 0 && rep_votes[i,2] < 1000){
    rep_votes[i,3] = "Gain - Small (<1000)"
  } else if(rep_votes[i,2] > 1000 && rep_votes[i,2] < 10000){
    rep_votes[i,3] = "Gain - Considerable (1000-10000)"
  } else if(rep_votes[i,2] >= 10000){
    rep_votes[i,3] = "Gain - Large (>10000)"
  } else if(rep_votes[i,2] < 0 && rep_votes[i,2] > -1000) {
    rep_votes[i,3] = "Loss - Small (<1000)"
  } else if(rep_votes[i,2] < -1000 && rep_votes[i,2] > -10000){
    rep_votes[i,3] = "Loss - Considerable (1000-10000)"
  } else if(rep_votes[i,2] < -10000){
    rep_votes[i,3] = "Loss - Large (>10000)"
  } else{
  rep_votes[i,3] = "Equal"
  }
}

c = CountyChoropleth$new(rep_votes)
c$title = "Change from Romney to Trump where Red Represents better Trump Performance"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(7)
c$ggplot_scale = scale_fill_manual(values = c("white","red","darkred","lightpink","blue","navy","deepskyblue"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
rep_change_US = c$render() + 
              theme(legend.position = "right")
rep_change_US

#Break down county vote into regions of the US for easier viewing

##New England Region
c = CountyChoropleth$new(rep_votes)
c$title = "Change from Romney to Trump (Red = Better Trump) - New England"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("red","darkred","lightpink","blue","navy","deepskyblue"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island"))
rep_change_NE = c$render() + 
              theme(legend.position = "right")
rep_change_NE

##Mid-Atlantic Region
c = CountyChoropleth$new(rep_votes)
c$title = "Change from Romney to Trump (Red = Better Trump) - Mid-Atlantic"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("red","darkred","lightpink","blue","navy","deepskyblue"))
c$set_zoom(c("new york", "pennsylvania", "new jersey", "maryland","delaware"))
rep_change_MA = c$render() + 
              theme(legend.position = "right")
rep_change_MA

##South East Region
c = CountyChoropleth$new(rep_votes)
c$title = "Change from Romney to Trump (Red = Better Trump) - South East"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("red","darkred","lightpink","blue","navy","deepskyblue"))
c$set_zoom(c("west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana"))
rep_change_SE = c$render() + 
              theme(legend.position = "right")
rep_change_SE

##Mid West Region
c = CountyChoropleth$new(rep_votes)
c$title = "Change from Romney to Trump (Red = Better Trump) - Mid West"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("red","darkred","lightpink","blue","navy","deepskyblue"))
c$set_zoom(c("ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas"))
rep_change_MW = c$render() + 
              theme(legend.position = "right")
rep_change_MW

##South West Region
c = CountyChoropleth$new(rep_votes)
c$title = "Change from Romney to Trump (Red = Better Trump) - South West"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("red","darkred","lightpink","blue","navy","deepskyblue"))
c$set_zoom(c("texas","oklahoma","new mexico","arizona"))
rep_change_SW = c$render() + 
              theme(legend.position = "right")
rep_change_SW

##West Region
c = CountyChoropleth$new(rep_votes)
c$title = "Change from Romney to Trump (Red = Better Trump) - West"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(7)
c$ggplot_scale = scale_fill_manual(values = c("white","red","darkred","lightpink","blue","navy","deepskyblue"))
c$set_zoom(c("colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington","alaska","hawaii"))
rep_change_W = c$render() + 
              theme(legend.position = "right")
rep_change_W

#Explore Vote Count by Swing States
c = CountyChoropleth$new(rep_votes)
c$title = "Change from Romney to Trump (Red = Better Trump) - Swing States"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(7)
c$ggplot_scale = scale_fill_manual(values = c("white","red","darkred","lightpink","blue","navy","deepskyblue"))
c$set_zoom(c("new hampshire","pennsylvania","ohio","michigan","north carolina","florida","arizona","iowa","nevada","wisconsin","virginia","colorado","minnesota","maine"))
rep_change_swing = c$render() + 
              theme(legend.position = "right")
rep_change_swing
```
#Interesting State Examiniation

##Examine Wisconsin
```{r examine Wisconsin, cache=TRUE}
#Clinton
c = CountyChoropleth$new(dem_votes)
c$title = "Change from Obama to Clinton (Blue = Better Clinton) - Wisconsin"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(4)
c$ggplot_scale = scale_fill_manual(values = c("blue","red","darkred","lightpink"))
c$set_zoom("wisconsin")
dem_change_WI = c$render() + 
              theme(legend.position = "right")
dem_change_WI

#Trump
c = CountyChoropleth$new(rep_votes)
c$title = "Change from Romney to Trump (Red = Better Trump) - Wisconsin"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(5)
c$ggplot_scale = scale_fill_manual(values = c("red","lightpink","blue","navy","deepskyblue"))
c$set_zoom("wisconsin")
rep_change_WI = c$render() + 
              theme(legend.position = "right")
rep_change_WI

#Appear to be more significant losses for Clinton than gains for Trump
```

##Examine Texas
```{r examine Texas,cache=TRUE}
#Clinton
c = CountyChoropleth$new(dem_votes)
c$title = "Change from Obama to Clinton (Blue = Better Clinton) - Texas"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("white","blue","navy","deepskyblue","red","lightpink"))
c$set_zoom("texas")
dem_change_TX = c$render() + 
              theme(legend.position = "right")
dem_change_TX

#Trump
c = CountyChoropleth$new(rep_votes)
c$title = "Change from Romney to Trump (Red = Better Trump) - Texas"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("red","darkred", "lightpink","blue","navy","deepskyblue"))
c$set_zoom("texas")
rep_change_TX = c$render() + 
              theme(legend.position = "right")
rep_change_TX
```

##Examine Arizona
```{r examine Arizona, cache=TRUE}
#Clinton
c = CountyChoropleth$new(dem_votes)
c$title = "Change from Obama to Clinton (Blue = Better Clinton) - Arizona"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(5)
c$ggplot_scale = scale_fill_manual(values = c("blue","navy","deepskyblue","red","lightpink"))
c$set_zoom("arizona")
dem_change_AZ = c$render() + 
              theme(legend.position = "right")
dem_change_AZ

#Trump
c = CountyChoropleth$new(rep_votes)
c$title = "Change from Romney to Trump (Red = Better Trump) - Arizona"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(5)
c$ggplot_scale = scale_fill_manual(values = c("red","lightpink","blue","navy","deepskyblue"))
c$set_zoom("arizona")
rep_change_AZ = c$render() + 
              theme(legend.position = "right")
rep_change_AZ
```

#Percentage Shift from 2012
```{r percentage shift from 2012 (Obama-Romney) to 2016 (Clinton-Trump),cache=TRUE}
votes$per_shift = votes$Trump_Romney - votes$Clinton_Obama

shift = votes[,c(1,98)]

summary(shift$per_shift)

ggplot(shift,aes(x="distribution",y=per_shift)) + geom_boxplot(fill = "firebrick", colour = "darkblue") + ggtitle("County Shifts toward Republican from 2012 to 2016") + ylab("Percentage Shift toward Republican from 2012 to 2016")

shift[,3] = NA
colnames(shift) = c('region','shift','value')

for(i in seq(1:dim(shift)[1])){
  if(shift[i,2] > 0 && shift[i,2] < .05){
    shift[i,3] = "GOP - Small (<5%)"
  } else if(shift[i,2] > .05 && shift[i,2] < .10){
    shift[i,3] = "GOP - Considerable (<10%)"
  } else if(shift[i,2] >= .10){
    shift[i,3] = "GOP - Large (>10%)"
  } else if(shift[i,2] < 0 && shift[i,2] > -.05) {
    shift[i,3] = "Dem - Small (<5%)"
  } else if(shift[i,2] < -.05 && shift[i,2] > -.10){
    shift[i,3] = "Dem - Considerable (<10%)"
  } else if(shift[i,2] < -.10){
    shift[i,3] = "Dem - Large (>10%)"
  } else{
  shift[i,3] = "Equal"
  }
}

#Entire country
c = CountyChoropleth$new(shift)
c$title = "Shift from 2012 to 2016 by County Percentage"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
per_change_US = c$render() + 
              theme(legend.position = "right")
per_change_US

#Break down county vote into regions of the US for easier viewing

##New England Region
c = CountyChoropleth$new(shift)
c$title = "Percentage Shift from 2012 to 2016 - New England"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island"))
per_change_NE = c$render() + 
              theme(legend.position = "right")
per_change_NE

##Mid-Atlantic Region
c = CountyChoropleth$new(shift)
c$title = "Percentage Shift from 2012 to 2016 - Mid-Atlantic"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("new york", "pennsylvania", "new jersey", "maryland","delaware"))
per_change_MA = c$render() + 
              theme(legend.position = "right")
per_change_MA

##South East Region
c = CountyChoropleth$new(shift)
c$title = "Percentage Shift from 2012 to 2016 - South East"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana"))
per_change_SE = c$render() + 
              theme(legend.position = "right")
per_change_SE

##Mid West Region
c = CountyChoropleth$new(shift)
c$title = "Percentage Shift from 2012 to 2016 - Mid West"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas"))
per_change_MW = c$render() + 
              theme(legend.position = "right")
per_change_MW

##South West Region
c = CountyChoropleth$new(shift)
c$title = "Percentage Shift from 2012 to 2016 - South West"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("texas","oklahoma","new mexico","arizona"))
per_change_SW = c$render() + 
              theme(legend.position = "right")
per_change_SW

##West Region
c = CountyChoropleth$new(shift)
c$title = "Percentage Shift from 2012 to 2016 - West"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington","alaska","hawaii"))
per_change_W = c$render() + 
              theme(legend.position = "right")
per_change_W

#Explore Vote Count by Swing States
c = CountyChoropleth$new(shift)
c$title = "Percentage Shift from 2012 to 2016 - Swing States"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("blue","navy","deepskyblue","red","darkred","lightpink"))
c$set_zoom(c("new hampshire","pennsylvania","ohio","michigan","north carolina","florida","arizona","iowa","nevada","wisconsin","virginia","colorado","minnesota","maine"))
per_change_swing = c$render() + 
              theme(legend.position = "right")
per_change_swing
```

##Analyze shifts at county level
```{r County shifts analysis,cache=TRUE}
total_shift = merge(x=dem_votes,y=rep_votes,by="region",all=TRUE)
total_shift[,6] = NA
colnames(total_shift) = c("region","dem_votes","dem_gain_loss","rep_votes","rep_gain_loss","value")

for(i in seq(i:dim(total_shift)[1])){
  if(total_shift[i,2] < 0){
    if(total_shift[i,4] < 0){
      total_shift[i,6] = "Dem Loss/GOP Loss"
    } else if(total_shift[i,4] > 0) {
      total_shift[i,6] = "Dem Loss/GOP Gain"
    } else {
      total_shift[i,6] = "Dem Loss/GOP Equal"
    }
  } else if(total_shift[i,2] > 0){
    if(total_shift[i,4] < 0){
      total_shift[i,6] = "Dem Gain/GOP Loss"
    } else if(total_shift[i,4] > 0){
      total_shift[i,6] = "Dem Gain/GOP Gain"
    } else {
      total_shift[i,6] = "Dem Gain/GOP Equal"
    }
  } else {
    if(total_shift[i,4] < 0){
      total_shift[i,6] = "Dem Equal/GOP Loss"
    } else if(total_shift[i,4] > 0){
      total_shift[i,6] = "Dem Equal/GOP Gain"
    } else {
      total_shift[i,6] = "Dem Equal/GOP Equal"
    }
  }
}

#Entire country
c = CountyChoropleth$new(total_shift)
c$title = "Shift from 2012 to 2016 by County Total Votes for Parties"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(7)
c$ggplot_scale = scale_fill_manual(values = c("lightpink", "deepskyblue","yellow","navy","grey","red","green"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
shift_US = c$render() + 
              theme(legend.position = "right")
shift_US

#Break down county vote into regions of the US for easier viewing

#New England Region
c = CountyChoropleth$new(total_shift)
c$title = "Shift from 2012 to 2016 by County Total Votes - New England"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(4)
c$ggplot_scale = scale_fill_manual(values = c("yellow","navy","red","green"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island"))
shift_NE = c$render() + 
              theme(legend.position = "right")
shift_NE

##Mid-Atlantic Region
c = CountyChoropleth$new(total_shift)
c$title = "Shift from 2012 to 2016 by County Total Votes - Mid-Atlantic"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(4)
c$ggplot_scale = scale_fill_manual(values = c("yellow","navy","red","green"))
c$set_zoom(c("new york", "pennsylvania", "new jersey", "maryland","delaware"))
shift_MA = c$render() + 
              theme(legend.position = "right")
shift_MA

##South East Region
c = CountyChoropleth$new(total_shift)
c$title = "Shift from 2012 to 2016 by County Total Votes - South East"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(5)
c$ggplot_scale = scale_fill_manual(values = c("lightpink","yellow","navy","red","green"))
c$set_zoom(c("west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana"))
shift_SE = c$render() + 
              theme(legend.position = "right")
shift_SE

##Mid West Region
c = CountyChoropleth$new(total_shift)
c$title = "Shift from 2012 to 2016 by County Total Votes - Mid West"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(4)
c$ggplot_scale = scale_fill_manual(values = c("yellow","navy","red","green"))
c$set_zoom(c("ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas"))
shift_MW = c$render() + 
              theme(legend.position = "right")
shift_MW

##South West Region
c = CountyChoropleth$new(total_shift)
c$title = "Shift from 2012 to 2016 by County Total Votes - South West"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(5)
c$ggplot_scale = scale_fill_manual(values = c("lightpink","yellow","navy","red","green"))
c$set_zoom(c("texas","oklahoma","new mexico","arizona"))
shift_SW = c$render() + 
              theme(legend.position = "right")
shift_SW

##West Region
c = CountyChoropleth$new(total_shift)
c$title = "Shift from 2012 to 2016 by County Total Votes - West"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("lightpink","yellow","navy","grey","red","green"))
c$set_zoom(c("colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington","alaska","hawaii"))
shift_W = c$render() + 
              theme(legend.position = "right")
shift_W

#Explore Vote Count by Swing States
c = CountyChoropleth$new(total_shift)
c$title = "Shift from 2012 to 2016 by County Total Votes - Swing States"
c$add_state_outline = TRUE
c$legend = "Change in Votes"
c$set_num_colors(5)
c$ggplot_scale = scale_fill_manual(values = c("yellow","navy","lightpink","red","green"))
c$set_zoom(c("new hampshire","pennsylvania","ohio","michigan","north carolina","florida","arizona","iowa","nevada","wisconsin","virginia","colorado","minnesota","maine"))
shift_swing = c$render() + 
              theme(legend.position = "right")
shift_swing
```

#Vote Share at State Level
```{r state level vote,cache=TRUE}
#create empty vector to store the state fips values
state_levels = vector()

#store unique fips in vector
for(i in seq(i:dim(votes)[1])){
  if(!is.element(votes[i,18],state_levels)){
    state_levels = c(state_levels,votes[i,18])
  }
}

#create dataframe, add state_levels to it, rename it to "fips.numeric" in order to join with state.regions data to get the region names
states = data.frame(state_levels)
states[,c(2:9)] = 0
colnames(states)[1] = "fips.numeric"

#read in data, merge, drop duplicate column, and rename columns
data(state.regions)
states = merge(x=states,y=state.regions,by="fips.numeric")
states = states[,c(1:11)]
colnames(states) = c("fips", "dem_votes_2016", "gop_votes_2016", "total_votes_2016", "dem_votes_2012", "gop_votes_2012", "total_votes_2012","pop_2010","pop_2014","region","abb")

for(i in seq(1:dim(votes)[1])){
  for(j in seq(1:dim(states)[1])){
    if(votes[i,12] == states[j,11]){
      states[j,2] = states[j,2] + votes[i,5]
      states[j,3] = states[j,3] + votes[i,6]
      states[j,4] = states[j,4] + votes[i,7]
      states[j,5] = states[j,5] + votes[i,15]
      states[j,6] = states[j,6] + votes[i,16]
      states[j,7] = states[j,7] + votes[i,14]
      states[j,8] = states[j,8] + votes[i,27]
      states[j,9] = states[j,9] + votes[i,26]
    }
  }
}

#Plot Voter Participation Changes
states$participation_change = states$total_votes_2016 - states$total_votes_2012

voting_num = states[,c(10,12)]
colnames(voting_num) = c("region","value")

ggplot(voting_num,aes(x="distribution",y=value)) + geom_boxplot(fill = "firebrick", colour = "darkblue") + ggtitle("County Shifts in Total Votes Cast from 2012 to 2016") + ylab("Total Number of Votes Cast Change")

c = StateChoropleth$new(voting_num)
c$title = "Shift from 2012 to 2016 by Total Number of Votes Cast"
c$add_state_outline = TRUE
c$legend = "Change in Votes Cast"
c$set_num_colors(1)
vote_US = c$render() + 
              theme(legend.position = "right")
vote_US

states$pop_2012 = states$pop_2010 + (states$pop_2014 - states$pop_2010)

states$pop_2016 = states$pop_2014 + (states$pop_2014 - states$pop_2010)

states$per_vot_change = 100 * ((states$total_votes_2016/states$pop_2016) - (states$total_votes_2012/states$pop_2012))

per_vote_num = states[,c(10,15)]
colnames(per_vote_num)= c("region","value")


c = StateChoropleth$new(per_vote_num)
c$title = "Shift in Turnout from 2012 to 2016 by Estimated Population Size"
c$add_state_outline = TRUE
c$legend = "% Change in Votes Cast"
c$set_num_colors(8)
c$ggplot_scale = scale_fill_manual(values = c("navy","blue","lightblue","white", "lightpink", "red", "firebrick","darkred"))
per_vote_US = c$render() + 
              theme(legend.position = "right")
per_vote_US


#Results
states$DT_per = states$gop_votes_2016/states$total_votes_2016

states$HC_per = states$dem_votes_2016/states$total_votes_2016

states$third = (1 - states$DT_per - states$HC_per) * 100

states$DT_margin = (states$DT_per - states$HC_per) * 100

ggplot(states,aes(x="distribution",y=DT_margin)) + geom_boxplot(fill = "firebrick", colour = "darkblue") + ggtitle("% Donald Trump Won Per State") + ylab("Donald Trump %")

states$winner = NA

for(i in seq(1:dim(states)[1])){
  if(states[i,19] < -10){
    states[i,20] = "Clinton (>10%)"
  } 
  if(states[i,19] > -10 && states[i,19] < -5){
    states[i,20] = "Clinton (5% - 10%)"
  }
  if(states[i,19] > -5 && states[i,19] < -2){
    states[i,20] = "Clinton (2% - 5%)"
  } 
  if(states[i,19] > -2 && states[i,19] < 0){
    states[i,20] = "Clinton (<2%)"
  } 
  if(states[i,19] > 10){
    states[i,20] = "Trump (>10%)"
  } 
  if(states[i,19] < 10 && states[i,19] > 5){
    states[i,20] = "Trump (5% - 10%)"
  } 
  if(states[i,19] < 5 && states[i,19] > 2){
    states[i,20] = "Trump (2% - 5%)"
  } 
  if(states[i,19] < 2 && states[i,19] > 0){
    states[i,20] = "Trump (<2%)"
  } 
}

state_winner = states[,c(10,20)]
colnames(state_winner) = c("region","value")

c = StateChoropleth$new(state_winner)
c$title = "2016 State Winner Margin"
c$add_state_outline = TRUE
c$legend = "Win Margin %"
c$set_num_colors(8)
c$ggplot_scale = scale_fill_manual(values = c("lightblue","navy", "dodgerblue1","blue",  "lightpink", "firebrick","red", "darkred"))
winner_US = c$render() + 
              theme(legend.position = "right")
winner_US

#Third Party Vote
ggplot(states,aes(x="distribution",y=third)) + geom_boxplot(fill = "firebrick", colour = "darkblue") + ggtitle("% Third Party Per State") + ylab("Third Party Voting Percent per State")


state_third = states[,c(10,18)]

state_third$category = NA

for(i in seq(1:dim(state_third)[1])){
  if(state_third[i,2] < 3){
    state_third[i,3] = "< 3%"
  }
  if(state_third[i,2] > 3 && state_third[i,2] < 5){
    state_third[i,3] = "3% - 5%"
  }
  if(state_third[i,2] > 5 && state_third[i,2] < 7){
    state_third[i,3] = "5% - 7%"
  }
  if(state_third[i,2] > 7 && state_third[i,2] < 10){
    state_third[i,3] = "7% - 10%"
  }
  if(state_third[i,2] > 10 && state_third[i,2] < 15){
    state_third[i,3] = "10% - 15%"
  }
  if(state_third[i,2] > 15){
    state_third[i,3] = "> 15%"
  }
}

colnames(state_third) = c("region","third", "value")

c = StateChoropleth$new(state_third)
c$title = "2016 Third Party Vote by State"
c$add_state_outline = TRUE
c$legend = "Third Party %"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values = c("purple", "red","orange","blue", "green","yellow"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
state_third_US = c$render() + 
              theme(legend.position = "right")
state_third_US
```

#Examine County Level Winner
```{r Examine County Level Winner,cache=TRUE}
county_winner = votes[,c(1,8,9)]

county_winner$Trump_margin = (county_winner$Trump - county_winner$Clinton) * 100


for(i in seq(1:dim(county_winner)[1])){
  if(county_winner[i,4] < -10){
    county_winner[i,5] = "Clinton (>10%)"
  } 
  if(county_winner[i,4] > -10 && county_winner[i,4] < -5){
    county_winner[i,5] = "Clinton (5% - 10%)"
  }
  if(county_winner[i,4] > -5 && county_winner[i,4] < -2){
    county_winner[i,5] = "Clinton (2% - 5%)"
  } 
  if(county_winner[i,4] > -2 && county_winner[i,4] < 0){
    county_winner[i,5] = "Clinton (<2%)"
  } 
  if(county_winner[i,4] > 10){
    county_winner[i,5] = "Trump (>10%)"
  } 
  if(county_winner[i,4] < 10 && county_winner[i,4] > 5){
    county_winner[i,5] = "Trump (5% - 10%)"
  } 
  if(county_winner[i,4] < 5 && county_winner[i,4] > 2){
    county_winner[i,5] = "Trump (2% - 5%)"
  } 
  if(county_winner[i,4] < 2 && county_winner[i,4] > 0){
    county_winner[i,5] = "Trump (<2%)"
  } 
}


colnames(county_winner)[1] = "region"
colnames(county_winner)[5] = "value"

plot(density(county_winner[,4]), 
         main = "Trump County Margin Density Plot",
         ylab = "density")

c = CountyChoropleth$new(county_winner)
c$title = "County Winner Margin %"
c$add_state_outline = TRUE
c$legend = "County Winner Margin"
c$set_num_colors(8)
c$ggplot_scale = scale_fill_manual(values = c("lightblue","navy", "dodgerblue1","blue",  "lightpink", "darkred","red", "firebrick"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_US = c$render() + 
              theme(legend.position = "right")
county_US

#Break Down By Region for Easy Viewing

#New England
c = CountyChoropleth$new(county_winner)
c$title = "County Winner Margin % - New England"
c$add_state_outline = TRUE
c$legend = "County Winner Margin"
c$set_num_colors(8)
c$ggplot_scale = scale_fill_manual(values = c("lightblue","navy", "dodgerblue1","blue",  "lightpink", "darkred","red", "firebrick"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island"))
county_NE = c$render() + 
              theme(legend.position = "right")
county_NE

##Mid-Atlantic Region
c = CountyChoropleth$new(county_winner)
c$title = "County Winner Margin % - Mid-Atlantic"
c$add_state_outline = TRUE
c$legend = "County Winner Margin"
c$set_num_colors(8)
c$ggplot_scale = scale_fill_manual(values = c("lightblue","navy", "dodgerblue1","blue",  "lightpink", "darkred","red", "firebrick"))
c$set_zoom(c("new york", "pennsylvania", "new jersey", "maryland","delaware"))
county_MA = c$render() + 
              theme(legend.position = "right")
county_MA


##South East Region
c = CountyChoropleth$new(county_winner)
c$title = "County Winner Margin % - South East"
c$add_state_outline = TRUE
c$legend = "County Winner Margin"
c$set_num_colors(8)
c$ggplot_scale = scale_fill_manual(values = c("lightblue","navy", "dodgerblue1","blue",  "lightpink", "darkred","red", "firebrick"))
c$set_zoom(c("west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana"))
county_SE = c$render() + 
              theme(legend.position = "right")
county_SE

##Mid West Region
c = CountyChoropleth$new(county_winner)
c$title = "County Winner Margin % - Mid West"
c$add_state_outline = TRUE
c$legend = "County Winner Margin"
c$set_num_colors(8)
c$ggplot_scale = scale_fill_manual(values = c("lightblue","navy", "dodgerblue1","blue",  "lightpink", "darkred","red", "firebrick"))
c$set_zoom(c("ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas"))
county_MW = c$render() + 
              theme(legend.position = "right")
county_MW

##South West Region
c = CountyChoropleth$new(county_winner)
c$title = "County Winner Margin % - South West"
c$add_state_outline = TRUE
c$legend = "County Winner Margin"
c$set_num_colors(8)
c$ggplot_scale = scale_fill_manual(values = c("navy", "dodgerblue1","blue",  "lightpink", "darkred","red", "firebrick"))
c$set_zoom(c("texas","oklahoma","new mexico","arizona"))
county_SW = c$render() + 
              theme(legend.position = "right")
county_SW

##West Region
c = CountyChoropleth$new(county_winner)
c$title = "County Winner Margin % - West"
c$add_state_outline = TRUE
c$legend = "County Winner Margin"
c$set_num_colors(8)
c$ggplot_scale = scale_fill_manual(values = c("lightblue","navy", "dodgerblue1","blue",  "lightpink", "darkred","red", "firebrick"))
c$set_zoom(c("colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington","alaska","hawaii"))
county_W = c$render() + 
              theme(legend.position = "right")
county_W

#Explore Vote Count by Swing States
c = CountyChoropleth$new(county_winner)
c$title = "County Winner Margin % - Swing States"
c$add_state_outline = TRUE
c$legend = "County Winner Margin"
c$set_num_colors(8)
c$ggplot_scale = scale_fill_manual(values = c("lightblue","navy", "dodgerblue1","blue",  "lightpink", "darkred","red", "firebrick"))
c$set_zoom(c("new hampshire","pennsylvania","ohio","michigan","north carolina","florida","arizona","iowa","nevada","wisconsin","virginia","colorado","minnesota","maine"))
county_swing = c$render() + 
              theme(legend.position = "right")
county_swing
```

#Analyze Counties that Flipped 2012 to 2016
```{r County Flips,cache=TRUE}
votes$flips = NA

for(i in seq(1:dim(votes)[1])){
  if(votes[i,9] > votes[i,8] && votes[i,19] > votes[i,20]){
    votes[i,99] = "OBAMA to TRUMP"
  } else if(votes[i,9] < votes[i,8] && votes[i,19] < votes[i,20]){
    votes[i,99] = "ROMNEY to CLINTON"
  } else {
    votes[i,99] = "Solid County"
  }
}

flips = votes[,c(1,99)]
colnames(flips) = c("region","value")

c = CountyChoropleth$new(flips)
c$title = "County Flips from 2012 to 2016"
c$add_state_outline = TRUE
c$legend = "County Status"
c$set_num_colors(3)
c$ggplot_scale = scale_fill_manual(values = c("red","blue","white"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_flips = c$render() + 
              theme(legend.position = "right")
county_flips

#Number of Clinton Flips
length(which(votes$flips == "ROMNEY to CLINTON"))

#Number of Trump Flips
length(which(votes$flips == "OBAMA to TRUMP"))

#Number of counties that did not change
length(which(votes$flips == "Solid County"))
```

#Exploratory Analysis - Religion


##Explore religious variables
```{r Analysis,cache=TRUE}
#total religious population
religious = votes[,c(1,83)]
colnames(religious) = c("region","value")

c= CountyChoropleth$new(religious)
c$title = "Total Religious Population"
c$add_state_outline = TRUE
c$legend = "Religious Percentage"
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_religious = c$render() + theme(legend.position = "right")
county_religious

#Evangelical Population
evangelical = votes[,c(1,84)]
colnames(evangelical) = c("region","value")
evangelical$value = cut(evangelical$value, breaks = c(0,1,5,10,20,Inf))

c= CountyChoropleth$new(evangelical)
c$title = "Evangelical Population"
c$add_state_outline = TRUE
c$set_num_colors(5)
c$ggplot_scale = scale_fill_manual(values = c("white","darkseagreen1", "greenyellow","green",  "darkgreen"))
c$legend = "Evangelical Percentage"
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_evangelical = c$render() + theme(legend.position = "right")
county_evangelical

#Catholic Population
catholic = votes[,c(1,87)]
colnames(catholic) = c("region","value")
catholic$value = cut(catholic$value, breaks = c(0,1,5,10,20,Inf))

c= CountyChoropleth$new(catholic)
c$title = "Catholic Population"
c$add_state_outline = TRUE
c$set_num_colors(5)
c$ggplot_scale = scale_fill_manual(values = c("white","thistle1", "plum3","purple",  "purple4"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
c$legend = "Catholic Percentage"
county_catholic = c$render() + theme(legend.position = "right")
county_catholic

#Mormon Population
mormon = votes[,c(1,89)]
colnames(mormon) = c("region","value")
mormon$value = cut(mormon$value, breaks = c(0,1,5,10,20,Inf))

c= CountyChoropleth$new(mormon)
c$title = "Mormon Population"
c$add_state_outline = TRUE
c$legend = "Mormon Percentage"
c$set_num_colors(5)
c$ggplot_scale = scale_fill_manual(values = c("white","lightpink", "lightpink3","firebrick1",  "firebrick4"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_mormon = c$render() + theme(legend.position = "right")
county_mormon

#Jewish Population
jewish = votes[,c(1,88)]
colnames(jewish) = c("region","value")
jewish$value = cut(jewish$value, breaks = c(0,1,2,5,10,Inf))

c= CountyChoropleth$new(jewish)
c$title = "Jewish Population"
c$add_state_outline = TRUE
c$legend = "Jewish Percentage"
c$set_num_colors(5)
c$ggplot_scale = scale_fill_manual(values = c("white","cyan", "cyan3","blue",  "darkblue"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_jewish = c$render() + theme(legend.position = "right")
county_jewish

#Total Christian Population
votes$Christian = votes$Evangelical + votes$Protestant + votes$Catholic + votes$Historically_Black + votes$Orthodox
christian = votes[,c(1,100)]
colnames(christian) = c("region","value")
christian$value = cut(christian$value, breaks = c(0,10,20,30,40,50,60,70,Inf))


c= CountyChoropleth$new(christian)
c$title = "Christian Population"
c$add_state_outline = TRUE
c$set_num_colors(8)
c$ggplot_scale = scale_fill_manual(values = c("white","yellow", "salmon","springgreen","brown1", "deepskyblue", "darkmagenta", "darkblue"))
c$legend = "Christian Percentage"
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_christian = c$render() + theme(legend.position = "right")
county_christian
```

#Model Construction

##Prepare Data for Modeling
```{r Prepare Data for Modeling,cache=TRUE}
#change decimals to match the other percentage values
votes$Trump = votes$Trump * 100
votes$Clinton = votes$Clinton * 100
votes$Obama = votes$Obama * 100
votes$Romney = votes$Romney * 100
votes$White = votes$White * 100
votes$Black = votes$Black * 100
votes$Hispanic = votes$Hispanic * 100
votes$Clinton_Obama = votes$Clinton_Obama * 100
votes$Trump_Romney = votes$Trump_Romney * 100
votes$per_shift = votes$per_shift * 100

```

##Predict Clinton-Obama Deviation
```{r Clinton-Obama Deviation, results="hide",cache=TRUE}
CO_Dev_Predict = votes[,c(14:16,19,20,26:28,30:35,40,42:63,67:77,83:95,100)]

CO_Dev_Predict = na.omit(CO_Dev_Predict)

null_CO = lm(Clinton_Obama~1,data = CO_Dev_Predict)
full_CO = lm(Clinton_Obama~.,data = CO_Dev_Predict)

CO_Dev = step(null_CO,scope=list(upper=full_CO),data=CO_Dev_Predict,direction="both")

votes$CO_Dev_Pred = predict(CO_Dev,votes)
```

##Predict Trump-Romney Deviation
```{r Trump-Romney Deviation, results="hide",cache=TRUE}
TR_Dev_Predict =  votes[,c(14:16,19,20,26:28,30:35,40,42:63,67:76,78,83:95,100)]

TR_Dev_Predict = na.omit(TR_Dev_Predict)

null_TR = lm(Trump_Romney~1, data = TR_Dev_Predict)
full_TR = lm(Trump_Romney~., data = TR_Dev_Predict)

TR_Dev = step(null_TR,scope=list(upper=full_TR),data=TR_Dev_Predict,direction="both")

votes$TR_Dev_Pred = predict(TR_Dev, votes)
```

##Predict Overall Deviation
```{r Predict Deviation in 2016 from 2012, results = "hide",cache=TRUE}
Overall_Dev_Predict = votes[,c(14:16,19,20,26:28,30:35,40,42:63,67:76,83:95,98,100)]

Overall_Dev_Predict = na.omit(Overall_Dev_Predict)

null_Overall = lm(per_shift~1, data = Overall_Dev_Predict)
full_Overall = lm(per_shift~., data = Overall_Dev_Predict)

Overall_Dev = step(null_Overall,scope=list(upper=full_Overall),data=Overall_Dev_Predict, direction = "both")

votes$Overall_Dev_Pred = predict(Overall_Dev, votes)
```

##Deviation Graphics: Clinton-Obama
```{r Graph Deviations: Clinton-Obama,cache=TRUE}
summary(CO_Dev)

votes$model_error_CO = (votes$Clinton_Obama - votes$CO_Dev_Pred)

ME_CO = votes[,c(1,104)]
colnames(ME_CO) = c("region","value")
ME_CO$value = cut(ME_CO$value, breaks = c(-10,-5,-1,1,5,10,Inf))

c= CountyChoropleth$new(ME_CO)
c$title = "Model Deviation: Clinton-Obama"
c$add_state_outline = TRUE
c$legend = "Model Deviation"
c$set_num_colors(6)
c$ggplot_scale = scale_fill_manual(values=c("red","indianred1","white","lightcyan1","dodgerblue","darkblue"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_ME_CO = c$render() + theme(legend.position = "right")
county_ME_CO
```

##Deviation Graphics: Trump-Romney
```{r Graph Deviations: Trump-Romney,cache=TRUE}
summary(TR_Dev)

votes$model_error_TR = (votes$Trump_Romney - votes$TR_Dev_Pred)

ME_TR = votes[,c(1,105)]
colnames(ME_TR) = c("region","value")
ME_TR$value = cut(ME_TR$value, breaks = c(-25,-10,-5,-1,1,5,10,Inf))

c= CountyChoropleth$new(ME_TR)
c$title = "Model Deviation: Trump-Romney"
c$add_state_outline = TRUE
c$legend = "Model Deviation"
c$set_num_colors(7)
c$ggplot_scale = scale_fill_manual(values=c("darkblue","dodgerblue","lightcyan","white","indianred1","red","firebrick4"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_ME_TR = c$render() + theme(legend.position = "right")
county_ME_TR
```

##Deviation Graphics: Overall
```{r Graph Deviation: Overall 2016,cache=TRUE}
summary(Overall_Dev)

votes$model_error_overall = (votes$per_shift - votes$Overall_Dev_Pred)

ME_Overall = votes[,c(1,106)]
colnames(ME_Overall) = c("region","value")
ME_Overall$value = cut(ME_Overall$value, breaks = c(-30,-10,-5,-1,1,5,10,Inf))

c= CountyChoropleth$new(ME_Overall)
c$title = "Model Deviation: 2016 Election Results"
c$add_state_outline = TRUE
c$legend = "Model Deviation"
c$set_num_colors(7)
c$ggplot_scale = scale_fill_manual(values=c("darkblue","dodgerblue","lightcyan","white","indianred1","red","firebrick4"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_ME_Overall = c$render() + theme(legend.position = "right")
county_ME_Overall
```

###Predict Trump and Clinton percentage
```{r predict Trump/Clition percentage, results="hide",cache=TRUE}
Predict_Clinton = votes[,c(8,19,20,26:28,30:35,40,42:63,67:76,83:95,100)]
Predict_Trump = votes[,c(9,19,20,26:28,30:35,40,42:63,67:76,83:95,100)]

Predict_Clinton = na.omit(Predict_Clinton)
Predict_Trump = na.omit(Predict_Trump)

#Clinton
null_Clinton = lm(Clinton~1,data = Predict_Clinton)
full_Clinton = lm(Clinton~.,data = Predict_Clinton)
Clinton_Dev = step(null_Clinton,scope=list(upper=full_Clinton),data=Predict_Clinton,direction="both")
votes$Clinton_Percent_Predict = predict(Clinton_Dev,votes)

#Trump
null_Trump = lm(Trump~1,data = Predict_Trump)
full_Trump = lm(Trump~.,data = Predict_Trump)
Trump_Dev = step(null_Trump,scope=list(upper=full_Trump),data=Predict_Trump,direction="both")
votes$Trump_Percent_Predict = predict(Trump_Dev,votes)
```

###Analyze Predict Percentage
```{r Analyze Predict Percentage,cache=TRUE}
#Clinton
summary(Clinton_Dev)

Clinton_Deviation = data.frame(votes[,1])
Clinton_Deviation$deviation = votes$Clinton - votes$Clinton_Percent_Predict
colnames(Clinton_Deviation) = c("region", "value")
Clinton_Deviation$value = cut(Clinton_Deviation$value, breaks = c(-10,-5,-1,1,5,10,Inf))

c= CountyChoropleth$new(Clinton_Deviation)
c$title = "Clinton Percentage Deviation"
c$add_state_outline = TRUE
c$legend = "Model Deviation"
c$set_num_colors(7)
c$ggplot_scale = scale_fill_manual(values=c("red","indianred1","white","lightcyan1","dodgerblue","darkblue"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_Trump_Dev = c$render() + theme(legend.position = "right")
county_Clinton_Dev = c$render() + theme(legend.position = "right")
county_Clinton_Dev

#Trump
summary(Trump_Dev)

Trump_Deviation = data.frame(votes[,1])
Trump_Deviation$deviation = votes$Trump - votes$Trump_Percent_Predict
colnames(Trump_Deviation) = c("region", "value")
Trump_Deviation$value = cut(Trump_Deviation$value, breaks = c(-25,-10,-5,-1,1,5,10,Inf))

c= CountyChoropleth$new(Trump_Deviation)
c$title = "Trump Percentage Deviation"
c$add_state_outline = TRUE
c$legend = "Model Deviation"
c$set_num_colors(7)
c$ggplot_scale = scale_fill_manual(values=c("darkblue","dodgerblue","lightcyan","white","indianred1","red","firebrick4"))
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_Trump_Dev = c$render() + theme(legend.position = "right")
county_Trump_Dev
```

#Predict Total Votes
```{r predict total votes Trump/Clinton, results="hide",cache=TRUE}
Predict_Votes_Clinton = votes[,c(5,14:16,19,20,26:28,30:35,40,42:63,67:76,83:95,100)]
Predict_Votes_Trump = votes[,c(6,14:16,19,20,26:28,30:35,40,42:63,67:76,83:95,100)]

Predict_Votes_Clinton = na.omit(Predict_Votes_Clinton)
Predict_Votes_Trump = na.omit(Predict_Votes_Trump)

#Clinton
null_Votes_Clinton = lm(votes_dem_2016~1,data = Predict_Votes_Clinton)
full_Votes_Clinton = lm(votes_dem_2016~.,data = Predict_Votes_Clinton)
Clinton_Votes_Dev = step(null_Votes_Clinton,scope=list(upper=full_Votes_Clinton),data=Predict_Votes_Clinton,direction="both")
votes$Clinton_Votes_Predict = predict(Clinton_Votes_Dev,votes)

#Trump
null_Votes_Trump = lm(votes_gop_2016~1,data = Predict_Votes_Trump)
full_Votes_Trump = lm(votes_gop_2016~.,data = Predict_Votes_Trump)
Trump_Votes_Dev = step(null_Votes_Trump,scope=list(upper=full_Votes_Trump),data=Predict_Votes_Trump,direction="both")
votes$Trump_Votes_Predict = predict(Trump_Votes_Dev,votes)
```


##Analyze Total Votes
```{r Analyze Total Votes,cache=TRUE}
summary(Clinton_Votes_Dev)
summary(Trump_Votes_Dev)

state_predict = data.frame(states[,c(1,10,11)])
state_predict$gop_votes = 0
state_predict$dem_votes = 0
state_predict$winner = NA

for(i in seq(1:dim(votes)[1])){
  for(j in seq(1:dim(state_predict)[1])){
    if(votes[i,12] == state_predict[j,3] && !is.na(votes[i,109]) && !is.na(votes[i,110])){
      state_predict[j,4] = state_predict[j,4] + votes[i,110]
      state_predict[j,5] = state_predict[j,5] + votes[i,109]
    }
  }
}

for(i in seq(1:dim(state_predict)[1])){
  if(state_predict[i,4] > state_predict[i,5]){
    state_predict[i,6] = "TRUMP"
  }
  if(state_predict[i,4] < state_predict[i,5]){
    state_predict[i,6] = "CLINTON"
  }
  if(state_predict[i,4] == state_predict[i,5]){
    state_predict[i,6] = "TIE"
  }
}

colnames(state_predict)[2] = "region"
colnames(state_predict)[6] = "value"

state_predict$gop_margin = ((state_predict$gop_votes - state_predict$dem_votes) / (state_predict$gop_votes + state_predict$dem_votes)) * 100

c = StateChoropleth$new(state_predict)
c$title = "2016 Winner Predicted by Model"
c$add_state_outline = TRUE
c$legend = "Winner"
c$set_num_colors(3)
c$ggplot_scale = scale_fill_manual(values = c("blue","red","white"))
state_predict2 = c$render() + 
              theme(legend.position = "right")
state_predict2

state_margin = state_predict[,c(2,7)]
colnames(state_margin) = c("region", "value")
state_margin$value = cut(state_margin$value, breaks = c(-100,-10,-5,-1,1,5,10,100))

c = StateChoropleth$new(state_margin)
c$title = "2016 Winner Predicted by Model"
c$add_state_outline = TRUE
c$legend = "Model Predicted Win Margin"
c$set_num_colors(7)
c$ggplot_scale = scale_fill_manual(values=c("darkblue","dodgerblue","lightcyan","white","indianred1","red","firebrick4"))
state_predict3 = c$render() + 
              theme(legend.position = "right")
state_predict3


```



#Correlation Analysis
```{r Collelation Analysis, cache=TRUE}
library(corrplot)

corr_subset = subset(votes, select=c(Trump,Clinton,Romney,Obama,population_change,White,Black,Hispanic,Income,Edu_highschool,Edu_batchelors))
corr_subset_religion = subset(votes, select=c(Trump,Clinton,Romney,Obama,Evangelical,Protestant,Catholic,Jewish,Mormon,Christian))

correlation = cor(corr_subset,use = "complete.obs")
correlation_religion = cor(corr_subset_religion,use = "complete.obs")


demographics = corrplot(correlation, method="shade", shade.col=NA, tl.col="black", tl.srt=45, addCoef.col="black", addcolorlabel="no")
religion = corrplot(correlation_religion, method="shade", shade.col=NA, tl.col="black", tl.srt=45, addCoef.col="black", addcolorlabel="no")

demographics
religion
```


#Most Important Feature Analysis

##Clinton
```{r Most Important Features-Clinton,cache=TRUE}
library(h2o)

h2o.init(nthreads=-1,max_mem_size='6G')

predict.Clinton = as.h2o(Predict_Clinton)
vars.Clinton = colnames(predict.Clinton)
x_vars.Clinton = c(vars.Clinton[2:59])
y_var.Clinton = vars.Clinton[1]

Clinton_features = h2o.randomForest(x=x_vars.Clinton,
                                y=y_var.Clinton,
                                seed=123,
                                training_frame = predict.Clinton,
                                ntrees=200,
                                stopping_rounds = 2,
                                score_each_iteration = TRUE,
                                nfolds = 10)

summary(Clinton_features)

h2o.varimp(Clinton_features)[1:20,]

h2o.varimp_plot(Clinton_features, num_of_features = 20)

```

##Trump
```{r Most Important Features - Trump,cache=TRUE}
predict.Trump = as.h2o(Predict_Trump)
vars.Trump = colnames(predict.Trump)
x_vars.Trump = c(vars.Trump[2:59])
y_var.Trump = vars.Trump[1]

Trump_features = h2o.randomForest(x=x_vars.Trump,
                                y=y_var.Trump,
                                seed=123,
                                training_frame = predict.Trump,
                                ntrees=200,
                                stopping_rounds = 2,
                                score_each_iteration = TRUE,
                                nfolds = 10)

summary(Trump_features)

h2o.varimp(Trump_features)[1:20,]

h2o.varimp_plot(Trump_features, num_of_features = 20)


```

##Swing Predict
```{r Most Important Features-Swing,cache=TRUE}
predict.Swing = as.h2o(Overall_Dev_Predict)
vars.Swing = colnames(predict.Swing)
x_vars.Swing = c(vars.Swing[1:60],vars.Swing[62])
y_var.Swing = vars.Swing[61]

Swing_features = h2o.randomForest(x=x_vars.Swing,
                                y=y_var.Swing,
                                seed=123,
                                training_frame = predict.Swing,
                                ntrees=200,
                                stopping_rounds = 2,
                                score_each_iteration = TRUE,
                                nfolds = 10)

summary(Swing_features)

h2o.varimp(Swing_features)[1:20,]

h2o.varimp_plot(Swing_features, num_of_features = 20)
```

###Correlation of Most important swing variables
```{r Correlation Swing,cache=TRUE}
corr_subset_swing = votes[,c(8,9,43,46,20,19,28,32,74,35,34,44,54)]

correlation_swing = cor(corr_subset_swing,use = "complete.obs")


swing = corrplot(correlation_swing, method="shade", shade.col=NA, tl.col="black", tl.srt=45, addCoef.col="black", addcolorlabel="no")


swing
```

###Prediction by Most Important Features
```{r Prediction - most important features, cache=T}

clinton_1 = summary(lm(Clinton ~ Obama, data=votes))$adj.r.squared
clinton_2 = summary(lm(Clinton ~ Obama + votes[,73],data=votes))$adj.r.squared
clinton_3 = summary(lm(Clinton ~ Obama + votes[,73] + votes[,51],data=votes))$adj.r.squared
clinton_4 = summary(lm(Clinton ~ Obama + votes[,73] + votes[,51] + votes[,35],data=votes))$adj.r.squared
clinton_5 = summary(lm(Clinton ~ Obama + votes[,73] + votes[,51] + votes[,35] + votes[,34],data=votes))$adj.r.squared

Clinton_rsq = c(0,clinton_1,clinton_2,clinton_3,clinton_4,clinton_5)

trump_1 = summary(lm(Trump ~ Romney, data=votes))$adj.r.squared
trump_2 = summary(lm(Trump ~ Romney + votes[,51], data=votes))$adj.r.squared
trump_3 = summary(lm(Trump ~ Romney + votes[,51] + votes[,73], data=votes))$adj.r.squared
trump_4 = summary(lm(Trump ~ Romney + votes[,51] + votes[,73] + votes[,46], data=votes))$adj.r.squared
trump_5 = summary(lm(Trump ~ Romney + votes[,51] + votes[,73] + votes[,46] + votes[,35], data=votes))$adj.r.squared

Trump_rsq = c(0,trump_1,trump_2,trump_3,trump_4,trump_5)

shift_1 = summary(lm(per_shift ~ votes[,43],data=votes))$adj.r.squared
shift_2 = summary(lm(per_shift ~ votes[,43] + votes[,46],data=votes))$adj.r.squared
shift_3 = summary(lm(per_shift ~ votes[,43] + votes[,46] + votes[,20],data=votes))$adj.r.squared
shift_4 = summary(lm(per_shift ~ votes[,43] + votes[,46] + votes[,20]+ votes[,28],data=votes))$adj.r.squared
shift_5 = summary(lm(per_shift ~ votes[,43] + votes[,46] + votes[,20]+ votes[,28] + votes[,32],data=votes))$adj.r.squared

theshift = c(0,shift_1,shift_2,shift_3,shift_4,shift_5)
num = c(0,1,2,3,4,5)


theMax = max(Clinton_rsq,Trump_rsq,theshift)
theMin = min(Clinton_rsq,Trump_rsq,theshift)



plot(num,
     Clinton_rsq,
     col = "blue",
     type = "b",
     main = "Accuracy for Features Selected",
     xlab = "Number of features",
     ylab = "Accuracy",
     ylim=c(0,theMax))
par(new=T)
plot(num,
     Trump_rsq,
     col = "red",
     type = "b",
     main = "Accuracy for Features Selected",
     xlab = "Number of features",
     ylab = "Accuracy",
     ylim=c(0,theMax))
par(new=T)
plot(num,
     theshift,
     type = "b",
     main = "Accuracy for Features Selected",
     xlab = "Number of features",
     ylab = "Accuracy",
     ylim=c(0,theMax))
legend("bottomright",legend=c("Clinton","Trump","Shift"),fill=c('blue','red','black'))

cat("Clinton - Obama Variation:", clinton_1,"\n")
cat("Trump - Romney Variation:", trump_1)
```

###Swing Variable Understand
```{r Swing Variables, cache=T}
theSubset = votes[,c(19,20,28,31,32,34,35,40,43,44,46,52,54,55,74,84,85,86,89,98,100)]
Swing_features = lm(per_shift ~ .,data=theSubset)
summary(Swing_features)


```

#My Model
```{r my model, cache=T}
my_subset = votes[,c(28,32,34,40,46,51,52,55,74,84,89,98,100)]
my_subset = na.omit(my_subset)
my_subset$IncomeXPopChange = my_subset$population_change * my_subset$Edu_batchelors
my_model = lm(per_shift ~ .,data=my_subset)
summary(my_model)

```

#Separate Red, Blue, and Swing States

###Swing state categorization was determined based on a competitive ground
####While Utah appeared it may have been close for a while due to third party candidate Evan McMullin, Utah remains a red state because Clinton never made a play for the state and it appeared Trump would almost certainly win in the end
##### Red = 22, Blue = 14 + DC, Swing = 14
```{r separate the states,cahce=TRUE}
RedStates = votes[which(votes$state_abbr == "AL" |
                        votes$state_abbr == "Ak" |
                        votes$state_abbr == "AR" |
                        votes$state_abbr == "GA" |
                        votes$state_abbr == "ID" |
                        votes$state_abbr == "IN" |
                        votes$state_abbr == "KS" |
                        votes$state_abbr == "KY" |
                        votes$state_abbr == "LA" |
                        votes$state_abbr == "MS" |
                        votes$state_abbr == "MO" |
                        votes$state_abbr == "MT" |
                        votes$state_abbr == "NE" |
                        votes$state_abbr == "ND" |
                        votes$state_abbr == "OK" |
                        votes$state_abbr == "SC" |
                        votes$state_abbr == "SD" |
                        votes$state_abbr == "TN" |
                        votes$state_abbr == "TX" |
                        votes$state_abbr == "UT" |
                        votes$state_abbr == "WV" |
                        votes$state_abbr == "WY"),]

BlueStates = votes[which(votes$state_abbr == "CA" |
                         votes$state_abbr == "CT" |
                         votes$state_abbr == "DE" |
                         votes$state_abbr == "HI" |
                         votes$state_abbr == "IL" |
                         votes$state_abbr == "MA" |
                         votes$state_abbr == "MD" |
                         votes$state_abbr == "NJ" |
                         votes$state_abbr == "NM" |
                         votes$state_abbr == "NY" |
                         votes$state_abbr == "OR" |
                         votes$state_abbr == "RI" |
                         votes$state_abbr == "VT" |
                         votes$state_abbr == "WA" |
                         votes$state_abbr == "DC"),]

SwingStates = votes[which(votes$state_abbr == "AZ" |
                          votes$state_abbr == "CO" |
                          votes$state_abbr == "FL" |
                          votes$state_abbr == "IA" |
                          votes$state_abbr == "ME" |
                          votes$state_abbr == "MI" |
                          votes$state_abbr == "MN" |
                          votes$state_abbr == "NV" |
                          votes$state_abbr == "NH" |
                          votes$state_abbr == "NC" |
                          votes$state_abbr == "OH" |
                          votes$state_abbr == "PA" |
                          votes$state_abbr == "VA" |
                          votes$state_abbr == "WI"),]
```

##Analze Correlation Differences between states
```{r correlations red-blue-swing,cache=TRUE}
Red_subset1 = RedStates[,c(8,9,19,20,28,32,34,35,40,46,51)]
Red_subset2 = RedStates[,c(8,9,52,55,74,76,84,85,87,89,100)]

Blue_subset1 = BlueStates[,c(8,9,19,20,28,32,34,35,40,46,51)]
Blue_subset2 = BlueStates[,c(8,9,52,55,74,76,84,85,87,89,100)]

Swing_subset1 = SwingStates[,c(8,9,19,20,28,32,34,35,40,46,51)]
Swing_subset2 = SwingStates[,c(8,9,52,55,74,76,84,85,87,89,100)]

Red_cor1 = cor(Red_subset1,use = "complete.obs")
Red_cor2 = cor(Red_subset2,use = "complete.obs")
Blue_cor1 = cor(Blue_subset1,use = "complete.obs")
Blue_cor2 = cor(Blue_subset2,use = "complete.obs")
Swing_cor1 = cor(Swing_subset1,use = "complete.obs")
Swing_cor2 = cor(Swing_subset2,use = "complete.obs")

Red1 = corrplot(Red_cor1, method="shade", shade.col=NA, tl.col="black", tl.srt=45, addCoef.col="black", addcolorlabel="no",title="Correlation Red States")
Red2 = corrplot(Red_cor2, method="shade", shade.col=NA, tl.col="black", tl.srt=45, addCoef.col="black", addcolorlabel="no",title="Correlation Red States")
Blue1 = corrplot(Blue_cor1, method="shade", shade.col=NA, tl.col="black", tl.srt=45, addCoef.col="black", addcolorlabel="no",title="Correlation Blue States")
Blue2 = corrplot(Blue_cor2, method="shade", shade.col=NA, tl.col="black", tl.srt=45, addCoef.col="black", addcolorlabel="no",title="Correlation Blue States")
Swing1 = corrplot(Swing_cor1, method="shade", shade.col=NA, tl.col="black", tl.srt=45, addCoef.col="black", addcolorlabel="no",title="Correlation Swing States")
Swing2 = corrplot(Swing_cor2, method="shade", shade.col=NA, tl.col="black", tl.srt=45, addCoef.col="black", addcolorlabel="no",title="Correlation Swing States")

Red1
Red2
Blue1
Blue2
Swing1
Swing2
```

##Most Important Features
```{r most important features red-blue-swing,cache=TRUE}
Red_Features_clinton = RedStates[,c(8,19,20,26:28,30:35,40,42:63,67:76,83:85,87,89,100)]
Red_Features_Trump = RedStates[,c(9,19,20,26:28,30:35,40,42:63,67:76,83:85,87,89,100)]
Red_Features_Shift = RedStates[,c(19,20,26:28,30:35,40,42:63,67:76,83:85,87,89,98,100)]
Blue_Features_clinton = BlueStates[,c(8,19,20,26:28,30:35,40,42:63,67:76,83:85,87,89,100)]
Blue_Features_Trump = BlueStates[,c(9,19,20,26:28,30:35,40,42:63,67:76,83:85,87,89,100)]
Blue_Features_Shift = BlueStates[,c(19,20,26:28,30:35,40,42:63,67:76,83:85,87,89,98,100)]
Swing_Features_clinton = SwingStates[,c(8,19,20,26:28,30:35,40,42:63,67:76,83:85,87,89,100)]
Swing_Features_Trump = SwingStates[,c(9,19,20,26:28,30:35,40,42:63,67:76,83:85,87,89,100)]
Swing_Features_Shift = SwingStates[,c(19,20,26:28,30:35,40,42:63,67:76,83:85,87,89,98,100)]
```

###Red States

####Clinton
```{r Red State Clinton Most Important Features, cache=TRUE}
library(h2o)

h2o.init(nthreads=-1,max_mem_size='6G')

red.Clinton = as.h2o(Red_Features_clinton)
vars.Clinton = colnames(red.Clinton)
x_vars.Clinton = c(vars.Clinton[2:51])
y_var.Clinton = vars.Clinton[1]

Clinton_features = h2o.randomForest(x=x_vars.Clinton,
                                y=y_var.Clinton,
                                seed=123,
                                training_frame = red.Clinton,
                                ntrees=200,
                                stopping_rounds = 2,
                                score_each_iteration = TRUE,
                                nfolds = 10)

summary(Clinton_features)

h2o.varimp(Clinton_features)[1:20,]

h2o.varimp_plot(Clinton_features, num_of_features = 20)
```

####Trump
```{r Red State Trump Most Important Features, cache=TRUE}
red.Trump = as.h2o(Red_Features_Trump)
vars.Trump = colnames(red.Trump)
x_vars.Trump = c(vars.Trump[2:51])
y_var.Trump = vars.Trump[1]

Trump_features = h2o.randomForest(x=x_vars.Trump,
                                y=y_var.Trump,
                                seed=123,
                                training_frame = red.Trump,
                                ntrees=200,
                                stopping_rounds = 2,
                                score_each_iteration = TRUE,
                                nfolds = 10)

summary(Trump_features)

h2o.varimp(Trump_features)[1:20,]

h2o.varimp_plot(Trump_features, num_of_features = 20)
```

####Swing
```{r Red States Swing Most Important Features, cache=TRUE}
red.Swing = as.h2o(Red_Features_Shift)
vars.Swing = colnames(red.Swing)
x_vars.Swing = c(vars.Swing[c(1:49,51)])
y_var.Swing = vars.Swing[50]

Swing_features = h2o.randomForest(x=x_vars.Swing,
                                y=y_var.Swing,
                                seed=123,
                                training_frame = red.Swing,
                                ntrees=200,
                                stopping_rounds = 2,
                                score_each_iteration = TRUE,
                                nfolds = 10)

summary(Swing_features)

h2o.varimp(Swing_features)[1:20,]

h2o.varimp_plot(Swing_features, num_of_features = 20)


```

###Blue States

####Clinton
```{r Blue State Clinton Most Important Features, cache=TRUE}
blue.Clinton = as.h2o(Blue_Features_clinton)
vars.Clinton = colnames(blue.Clinton)
x_vars.Clinton = c(vars.Clinton[2:51])
y_var.Clinton = vars.Clinton[1]

Clinton_features = h2o.randomForest(x=x_vars.Clinton,
                                y=y_var.Clinton,
                                seed=123,
                                training_frame = blue.Clinton,
                                ntrees=200,
                                stopping_rounds = 2,
                                score_each_iteration = TRUE,
                                nfolds = 10)

summary(Clinton_features)

h2o.varimp(Clinton_features)[1:20,]

h2o.varimp_plot(Clinton_features, num_of_features = 20)
```

####Trump
```{r Blue State Trump Most Important Features, cache=TRUE}
blue.Trump = as.h2o(Blue_Features_Trump)
vars.Trump = colnames(blue.Trump)
x_vars.Trump = c(vars.Trump[2:51])
y_var.Trump = vars.Trump[1]

Trump_features = h2o.randomForest(x=x_vars.Trump,
                                y=y_var.Trump,
                                seed=123,
                                training_frame = blue.Trump,
                                ntrees=200,
                                stopping_rounds = 2,
                                score_each_iteration = TRUE,
                                nfolds = 10)

summary(Trump_features)

h2o.varimp(Trump_features)[1:20,]

h2o.varimp_plot(Trump_features, num_of_features = 20)
```

####Swing
```{r Blue States Swing Most Important Features, cache=TRUE}
blue.Swing = as.h2o(Blue_Features_Shift)
vars.Swing = colnames(blue.Swing)
x_vars.Swing = c(vars.Swing[c(1:49,51)])
y_var.Swing = vars.Swing[50]

Swing_features = h2o.randomForest(x=x_vars.Swing,
                                y=y_var.Swing,
                                seed=123,
                                training_frame = blue.Swing,
                                ntrees=200,
                                stopping_rounds = 2,
                                score_each_iteration = TRUE,
                                nfolds = 10)

summary(Swing_features)

h2o.varimp(Swing_features)[1:20,]

h2o.varimp_plot(Swing_features, num_of_features = 20)
```

###Swing States

####Clinton
```{r Swing State Clinton Most Important Features, cache=TRUE}
swing.Clinton = as.h2o(Swing_Features_clinton)
vars.Clinton = colnames(swing.Clinton)
x_vars.Clinton = c(vars.Clinton[2:51])
y_var.Clinton = vars.Clinton[1]

Clinton_features = h2o.randomForest(x=x_vars.Clinton,
                                y=y_var.Clinton,
                                seed=123,
                                training_frame = swing.Clinton,
                                ntrees=200,
                                stopping_rounds = 2,
                                score_each_iteration = TRUE,
                                nfolds = 10)

summary(Clinton_features)

h2o.varimp(Clinton_features)[1:20,]

h2o.varimp_plot(Clinton_features, num_of_features = 20)
```

####Trump
```{r Swing State Trump Most Important Features, cache=TRUE}
swing.Trump = as.h2o(Swing_Features_Trump)
vars.Trump = colnames(swing.Trump)
x_vars.Trump = c(vars.Trump[2:51])
y_var.Trump = vars.Trump[1]

Trump_features = h2o.randomForest(x=x_vars.Trump,
                                y=y_var.Trump,
                                seed=123,
                                training_frame = swing.Trump,
                                ntrees=200,
                                stopping_rounds = 2,
                                score_each_iteration = TRUE,
                                nfolds = 10)

summary(Trump_features)

h2o.varimp(Trump_features)[1:20,]

h2o.varimp_plot(Trump_features, num_of_features = 20)
```

####Swing
```{r Swing States Swing Most Important Features, cache=TRUE}
swing.Swing = as.h2o(Swing_Features_Shift)
vars.Swing = colnames(swing.Swing)
x_vars.Swing = c(vars.Swing[c(1:49,51)])
y_var.Swing = vars.Swing[50]

Swing_features = h2o.randomForest(x=x_vars.Swing,
                                y=y_var.Swing,
                                seed=123,
                                training_frame = swing.Swing,
                                ntrees=200,
                                stopping_rounds = 2,
                                score_each_iteration = TRUE,
                                nfolds = 10)

summary(Swing_features)

h2o.varimp(Swing_features)[1:20,]

h2o.varimp_plot(Swing_features, num_of_features = 20)
```

###Explaining away the Shift in Swing States
```{r explaining away shift in swing states,cache=T}
Swing_1 = summary(lm(per_shift ~ Swing_Features_Shift[,17], data=Swing_Features_Shift))$adj.r.squared
Swing_2 = summary(lm(per_shift ~ Swing_Features_Shift[,17] + Swing_Features_Shift[,5],data=Swing_Features_Shift))$adj.r.squared
Swing_3 = summary(lm(per_shift ~ Swing_Features_Shift[,17] + Swing_Features_Shift[,5] + Swing_Features_Shift[,14],data=Swing_Features_Shift))$adj.r.squared
Swing_4 = summary(lm(per_shift ~ Swing_Features_Shift[,17] + Swing_Features_Shift[,5] + Swing_Features_Shift[,14] + Swing_Features_Shift[,23],data=Swing_Features_Shift))$adj.r.squared
Swing_5 = summary(lm(per_shift ~ Swing_Features_Shift[,17] + Swing_Features_Shift[,5] + Swing_Features_Shift[,14] + Swing_Features_Shift[,23] + Swing_Features_Shift[,10],data=Swing_Features_Shift))$adj.r.squared


theswing = c(0,Swing_1,Swing_2,Swing_3,Swing_4,Swing_5)
num = c(0,1,2,3,4,5)

plot(num,
     theswing,
     col = "blue",
     type = "b",
     main = "Accuracy for Features Selected",
     xlab = "Number of features",
     ylab = "Accuracy")

cat("Swing - Edu_batchelors:", Swing_1)
```

###My Model - Revisited
```{r My Model Revisited, cache=TRUE}
my_subset = Swing_Features_Shift[,c(5,8,10,12,17,22,23,26,42,46,50,51)]
my_subset = na.omit(my_subset)
my_subset$IncomeXPopChange = my_subset$population_change * my_subset$Edu_batchelors
my_model = lm(per_shift ~ .,data=my_subset)
summary(my_model)

```


#Polarization Measure

##Density Plot
```{r polarization measure - density, cache=TRUE}
votes$margin_2016 = abs(votes$Trump - votes$Clinton)
votes$margin_2012 = abs(votes$Obama - votes$Romney)
votes$polarization = votes$margin_2016 - votes$margin_2012

plot(density(votes$margin_2016), 
         main = "County Winner Density Plot",
         ylab = "density",
         xlab = "county margin",
         ylim=c(0,.020),
         xlim=c(0,100),
         col="red")
par(new=T)
plot(density(votes$margin_2012), 
         main = "County Winner Density Plot",
         ylab = "density",
         xlab = "county margin",
         ylim=c(0,.020),
         xlim=c(0,100),
         col="blue")
legend("topright",legend=c("2012","2016"),fill=c("blue","red"))
```


##Ploting Polarization
```{r Polarization Plots, cache=TRUE}
polarization = votes[,c(1,113)]
colnames(polarization) = c("region","value")
polarization$value = cut(polarization$value, breaks = c(-Inf,0,Inf), labels=c("Less Polarized","More Polarized"))


c= CountyChoropleth$new(polarization)
c$title = "Polarization Shift Measurement"
c$add_state_outline = TRUE
c$set_num_colors(2)
c$ggplot_scale = scale_fill_manual(values = c("darkblue","red"))
c$legend = "Polarization Scale"
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_polarization = c$render() + theme(legend.position = "right")
county_polarization
```

##2016 Polarization Results
```{r 2016 polarization results, cache=TRUE}
polarization2016 = votes[,c(1,111)]
colnames(polarization2016) = c("region","value")
polarization2016$value = cut(polarization2016$value, breaks = c(0,10,20,50,Inf), labels=c("0%-10% Margin","10%-20% Margin","20%-50% Margin","50%-100% Margin"))


c= CountyChoropleth$new(polarization2016)
c$title = "Polarization Measurement - 2016"
c$add_state_outline = TRUE
c$set_num_colors(4)
c$ggplot_scale = scale_fill_manual(values = c("darkblue","lightblue","red","darkred"))
c$legend = "Polarization Scale"
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_polarization2016 = c$render() + theme(legend.position = "right")
county_polarization2016

polarization2012 = votes[,c(1,112)]
colnames(polarization2012) = c("region","value")
polarization2012$value = cut(polarization2012$value, breaks = c(0,10,20,50,Inf), labels=c("0%-10% Margin","10%-20% Margin","20%-50% Margin","50%-100% Margin"))


c= CountyChoropleth$new(polarization2012)
c$title = "Polarization Measurement - 2012"
c$add_state_outline = TRUE
c$set_num_colors(4)
c$ggplot_scale = scale_fill_manual(values = c("darkblue","lightblue","red","darkred"))
c$legend = "Polarization Scale"
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_polarization2012 = c$render() + theme(legend.position = "right")
county_polarization2012


polarization10 = votes[,c(1,111)]
colnames(polarization10) = c("region","value")
polarization10$value = cut(polarization10$value, breaks = c(0,10,Inf), labels=c("<10% Margin",">10% Margin"))


c= CountyChoropleth$new(polarization10)
c$title = "Polarization @ 10% Margin - 2016"
c$add_state_outline = TRUE
c$set_num_colors(2)
c$ggplot_scale = scale_fill_manual(values = c("darkblue","white"))
c$legend = "Polarization Scale"
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_polarization10 = c$render() + theme(legend.position = "right")
county_polarization10

polarization102 = votes[,c(1,112)]
colnames(polarization102) = c("region","value")
polarization102$value = cut(polarization102$value, breaks = c(0,10,Inf), labels=c("<10% Margin",">10% Margin"))


c= CountyChoropleth$new(polarization102)
c$title = "Polarization @ 10% Margin - 2012"
c$add_state_outline = TRUE
c$set_num_colors(2)
c$ggplot_scale = scale_fill_manual(values = c("darkblue","white"))
c$legend = "Polarization Scale"
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_polarization102 = c$render() + theme(legend.position = "right")
county_polarization102

polarization20 = votes[,c(1,111)]
colnames(polarization20) = c("region","value")
polarization20$value = cut(polarization20$value, breaks = c(0,20,Inf), labels=c("<20% Margin",">20% Margin"))


c= CountyChoropleth$new(polarization20)
c$title = "Polarization @ 20% Margin - 2016"
c$add_state_outline = TRUE
c$set_num_colors(2)
c$ggplot_scale = scale_fill_manual(values = c("darkblue","white"))
c$legend = "Polarization Scale"
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_polarization20 = c$render() + theme(legend.position = "right")
county_polarization20

polarization202 = votes[,c(1,112)]
colnames(polarization202) = c("region","value")
polarization202$value = cut(polarization202$value, breaks = c(0,20,Inf), labels=c("<20% Margin",">20% Margin"))


c= CountyChoropleth$new(polarization202)
c$title = "Polarization @ 20% Margin - 2012"
c$add_state_outline = TRUE
c$set_num_colors(2)
c$ggplot_scale = scale_fill_manual(values = c("darkblue","white"))
c$legend = "Polarization Scale"
c$set_zoom(c("maine","new hampshire", "vermont", "massachusetts","connecticut","rhode island","new york", "pennsylvania", "new jersey", "maryland","delaware","west virginia","virginia","tennessee","kentucky","north carolina","south carolina","georgia","florida","arkansas","mississippi","alabama","louisiana","ohio","michigan","indiana","illinois","wisconsin","minnesota","iowa","missouri","north dakota","south dakota","nebraska","kansas","texas","oklahoma","new mexico","arizona","colorado","wyoming","montana","idaho","utah","nevada","california","oregon","washington"))
county_polarization202 = c$render() + theme(legend.position = "right")
county_polarization202
```

##Change in polarization
```{r change in polarization, cache=TRUE}

pol_2016 = (length(which(polarization10$value=="<10% Margin")) / dim(polarization10)[1]) * 100
pol_2012 = (length(which(polarization102$value=="<10% Margin")) / dim(polarization102)[1]) * 100
increase_pol10 = pol_2012 - pol_2016
cat("% Counties Polarization Increase @ 10% Level: ", increase_pol10, "\n")

pol_20162 = (length(which(polarization20$value=="<20% Margin")) / dim(polarization20)[1]) * 100
pol_20122 = (length(which(polarization202$value=="<20% Margin")) / dim(polarization202)[1]) * 100
increase_pol20 = pol_20122 - pol_20162
cat("% Counties Polarization Increase @ 20% Level: ", increase_pol20, "\n")

cat("% Counties that were within 20% points: ", (length(which(polarization20$value=="<20% Margin")) / dim(polarization20)[1]) * 100, "\n")
cat("% Counties that were within 10% points: ", (length(which(polarization10$value=="<10% Margin")) / dim(polarization10)[1]) * 100, "\n")

votes$AvgPol_2016 = votes$total_votes_2016 * votes$margin_2016
votes$AvgPol_2012 = votes$total_votes_2012 * votes$margin_2012

polarization_2016 = sum(votes$AvgPol_2016) / sum(votes$total_votes_2016)
cat('Polarization 2016: ',polarization_2016,'\n')

polarization_2012 = sum(votes$AvgPol_2012) / sum(votes$total_votes_2012)
cat('Polarization 2012:', polarization_2012,'\n')

pol_change = polarization_2016 - polarization_2012
cat('Polarization Change: ',pol_change,'\n')
```

